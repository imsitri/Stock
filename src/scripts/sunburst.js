const data = {
	name: "flare",
	children: [
		{
			name: "2003",
			children: [
				{
					name: "Jan",
					children: [
						{ name: "Week 1", value: 3938 },
						{ name: "Week 2", value: 3812 },
						{ name: "Week 3", value: 6714 },
						{ name: "Week 4", value: 743 },
					],
				},
				{
					name: "Feb",
					children: [
						{ name: "Week 1", value: 3534 },
						{ name: "Week 2", value: 5731 },
						{ name: "Week 3", value: 7840 },
						{ name: "Week 4", value: 5914 },
					],
				},
				{
					name: "March",
					children: [{ name: "Week 1", value: 7074 }],
				},
			],
		},
		{
			name: "2004",
			children: [
				{ name: "Jan", value: 17010 },
				{ name: "Feb", value: 5842 },
				{
					name: "March",
					children: [
						{ name: "Week 1", value: 1983 },
						{ name: "Week 2", value: 2047 },
						{ name: "Week 3", value: 1375 },
						{ name: "Week 4", value: 8746 }
					],
				},
				{ name: "March", value: 1041 },
				{ name: "April", value: 5176 },
				{ name: "May", value: 449 },
				{ name: "June", value: 5593 },
				{ name: "July", value: 5534 },
				{ name: "August", value: 9201 },
				{ name: "September", value: 19975 },
				{ name: "October", value: 1116 },
				{ name: "November", value: 6006 },
			],
		},
		{
			name: "2005",
			children: [
				{
					name: "April",
					children: [
						{ name: "Week 1", value: 721 },
						{ name: "Week 2", value: 4294 },
						{ name: "Week 3", value: 9800 },
						{ name: "Week 4", value: 1314 },
					],
				},
				{ name: "May", value: 1759 },
				{ name: "June", value: 2165 },
				{ name: "October", value: 586 },
				{ name: "November", value: 3331 },
				{ name: "December", value: 772 },
				{ name: "January", value: 3322 },
			],
		},
		{
			name: "2006",
			children: [
				{ name: "January", value: 8833 },
				{ name: "February", value: 1732 },
				{ name: "March", value: 3623 },
				{ name: "June", value: 10066 },
			],
		},
		{
			name: "2007",
			children: [{ name: "Jan", value: 4116 }],
		},
		{
			name: "2008",
			children: [
				{ name: "January", value: 1082 },
				{ name: "February", value: 1336 },
				{ name: "March", value: 319 },
				{ name: "April", value: 10498 },
				{ name: "May", value: 2822 },
				{ name: "June", value: 9983 },
				{ name: "July", value: 2213 },
				{ name: "August", value: 1681 },
			],
		},
		{
			name: "2009",
			children: [
				{ name: "January", value: 1082 },
				{ name: "February", value: 1336 },
				{ name: "March", value: 319 },
				{ name: "April", value: 10498 },
				{ name: "May", value: 2822 },

				{
					name: "September",
					children: [
						{ name: "Week 1", value: 593 },
						{ name: "Week 2", value: 330 },
						{ name: "Week 3", value: 287 },
						{ name: "Week 4", value: 277 },
					],
				},
				{ name: "June", value: 9983 },
				{ name: "July", value: 2213 },
				{ name: "August", value: 1681 },
				{ name: "September", value: 1681 },
				{ name: "October", value: 1681 },
				{ name: "November", value: 1681 },
			],
		},
		{
			name: "2010",
			children: [
				{ name: "January", value: 1082 },
				{ name: "February", value: 1336 },
				{ name: "March", value: 319 },
				{ name: "April", value: 10498 },
				{ name: "May", value: 2822 },
				{ name: "June", value: 9983 },
				{ name: "July", value: 2213 },
				{ name: "August", value: 1681 },
				{ name: "September", value: 1681 },
				{ name: "October", value: 1681 },
				{ name: "November", value: 1681 }
			],
		},
		// {
		// 	name: "2011",
		// 	children: [
		// 		{ name: "Arrays", value: 8258 },
		// 		{ name: "Colors", value: 10001 },
		// 		{ name: "Dates", value: 8217 },
		// 		{ name: "Displays", value: 12555 },
		// 		{ name: "Filter", value: 2324 },
		// 		{ name: "Geometry", value: 10993 },
		// 		{
		// 			name: "heap",
		// 			children: [
		// 				{ name: "FibonacciHeap", value: 9354 },
		// 				{ name: "HeapNode", value: 1233 },
		// 			],
		// 		},
		// 		{ name: "IEvaluable", value: 335 },
		// 		{ name: "IPredicate", value: 383 },
		// 		{ name: "IValueProxy", value: 874 },
		// 		{
		// 			name: "math",
		// 			children: [
		// 				{ name: "DenseMatrix", value: 3165 },
		// 				{ name: "IMatrix", value: 2815 },
		// 				{ name: "SparseMatrix", value: 3366 },
		// 			],
		// 		},
		// 		{ name: "Maths", value: 17705 },
		// 		{ name: "Orientation", value: 1486 },
		// 		{
		// 			name: "palette",
		// 			children: [
		// 				{ name: "ColorPalette", value: 6367 },
		// 				{ name: "Palette", value: 1229 },
		// 				{ name: "ShapePalette", value: 2059 },
		// 				{ name: "SizePalette", value: 2291 },
		// 			],
		// 		},
		// 		{ name: "Property", value: 5559 },
		// 		{ name: "Shapes", value: 19118 },
		// 		{ name: "Sort", value: 6887 },
		// 		{ name: "Stats", value: 6557 },
		// 		{ name: "Strings", value: 22026 },
		// 	],
		// },
		// {
		// 	name: "2012",
		// 	children: [
		// 		{
		// 			name: "axis",
		// 			children: [
		// 				{ name: "Axes", value: 1302 },
		// 				{ name: "Axis", value: 24593 },
		// 				{ name: "AxisGridLine", value: 652 },
		// 				{ name: "AxisLabel", value: 636 },
		// 				{ name: "CartesianAxes", value: 6703 },
		// 			],
		// 		},
		// 		{
		// 			name: "controls",
		// 			children: [
		// 				{ name: "AnchorControl", value: 2138 },
		// 				{ name: "ClickControl", value: 3824 },
		// 				{ name: "Control", value: 1353 },
		// 				{ name: "ControlList", value: 4665 },
		// 				{ name: "DragControl", value: 2649 },
		// 				{ name: "ExpandControl", value: 2832 },
		// 				{ name: "HoverControl", value: 4896 },
		// 				{ name: "IControl", value: 763 },
		// 				{ name: "PanZoomControl", value: 5222 },
		// 				{ name: "SelectionControl", value: 7862 },
		// 				{ name: "TooltipControl", value: 8435 },
		// 			],
		// 		},
		// 		{
		// 			name: "data",
		// 			children: [
		// 				{ name: "Data", value: 20544 },
		// 				{ name: "DataList", value: 19788 },
		// 				{ name: "DataSprite", value: 10349 },
		// 				{ name: "EdgeSprite", value: 3301 },
		// 				{ name: "NodeSprite", value: 19382 },
		// 				{
		// 					name: "render",
		// 					children: [
		// 						{ name: "ArrowType", value: 698 },
		// 						{ name: "EdgeRenderer", value: 5569 },
		// 						{ name: "IRenderer", value: 353 },
		// 						{ name: "ShapeRenderer", value: 2247 },
		// 					],
		// 				},
		// 				{ name: "ScaleBinding", value: 11275 },
		// 				{ name: "Tree", value: 7147 },
		// 				{ name: "TreeBuilder", value: 9930 },
		// 			],
		// 		},
		// 		{
		// 			name: "events",
		// 			children: [
		// 				{ name: "DataEvent", value: 2313 },
		// 				{ name: "SelectionEvent", value: 1880 },
		// 				{ name: "TooltipEvent", value: 1701 },
		// 				{ name: "VisualizationEvent", value: 1117 },
		// 			],
		// 		},
		// 		{
		// 			name: "legend",
		// 			children: [
		// 				{ name: "Legend", value: 20859 },
		// 				{ name: "LegendItem", value: 4614 },
		// 				{ name: "LegendRange", value: 10530 },
		// 			],
		// 		},
		// 		{
		// 			name: "operator",
		// 			children: [
		// 				{
		// 					name: "distortion",
		// 					children: [
		// 						{ name: "BifocalDistortion", value: 4461 },
		// 						{ name: "Distortion", value: 6314 },
		// 						{ name: "FisheyeDistortion", value: 3444 },
		// 					],
		// 				},
		// 				{
		// 					name: "encoder",
		// 					children: [
		// 						{ name: "ColorEncoder", value: 3179 },
		// 						{ name: "Encoder", value: 4060 },
		// 						{ name: "PropertyEncoder", value: 4138 },
		// 						{ name: "ShapeEncoder", value: 1690 },
		// 						{ name: "SizeEncoder", value: 1830 },
		// 					],
		// 				},
		// 				{
		// 					name: "filter",
		// 					children: [
		// 						{ name: "FisheyeTreeFilter", value: 5219 },
		// 						{ name: "GraphDistanceFilter", value: 3165 },
		// 						{ name: "VisibilityFilter", value: 3509 },
		// 					],
		// 				},
		// 				{ name: "IOperator", value: 1286 },
		// 				{
		// 					name: "label",
		// 					children: [
		// 						{ name: "Labeler", value: 9956 },
		// 						{ name: "RadialLabeler", value: 3899 },
		// 						{ name: "StackedAreaLabeler", value: 3202 },
		// 					],
		// 				},
		// 				{
		// 					name: "layout",
		// 					children: [
		// 						{ name: "AxisLayout", value: 6725 },
		// 						{ name: "BundledEdgeRouter", value: 3727 },
		// 						{ name: "CircleLayout", value: 9317 },
		// 						{ name: "CirclePackingLayout", value: 12003 },
		// 						{ name: "DendrogramLayout", value: 4853 },
		// 						{ name: "ForceDirectedLayout", value: 8411 },
		// 						{ name: "IcicleTreeLayout", value: 4864 },
		// 						{ name: "IndentedTreeLayout", value: 3174 },
		// 						{ name: "Layout", value: 7881 },
		// 						{ name: "NodeLinkTreeLayout", value: 12870 },
		// 						{ name: "PieLayout", value: 2728 },
		// 						{ name: "RadialTreeLayout", value: 12348 },
		// 						{ name: "RandomLayout", value: 870 },
		// 						{ name: "StackedAreaLayout", value: 9121 },
		// 						{ name: "TreeMapLayout", value: 9191 },
		// 					],
		// 				},
		// 				{ name: "Operator", value: 2490 },
		// 				{ name: "OperatorList", value: 5248 },
		// 				{ name: "OperatorSequence", value: 4190 },
		// 				{ name: "OperatorSwitch", value: 2581 },
		// 				{ name: "SortOperator", value: 2023 },
		// 			],
		// 		},
		// 		{ name: "Visualization", value: 16540 },
		// 	],
		// },
	],
};

const partition = (data) => {
	const root = d3
		.hierarchy(data)
		.sum((d) => d.value)
		.sort((a, b) => b.value - a.value);
	return d3.partition().size([2 * Math.PI, root.height + 1])(root);
};

const root = partition(data);

root.each((d) => (d.current = d));

const width = 932;

const svg = d3
	.create("svg")
	.attr("viewBox", [0, 0, width, width])
	.style("font", "10px sans-serif");

const g = svg
	.append("g")
	.attr("transform", `translate(${width / 2},${width / 2})`);

const color = d3.scaleOrdinal(
	d3.quantize(d3.interpolateRainbow, data.children.length + 1)
);

const radius = width / 6;

const arc = d3
	.arc()
	.startAngle((d) => d.x0)
	.endAngle((d) => d.x1)
	.padAngle((d) => Math.min((d.x1 - d.x0) / 2, 0.005))
	.padRadius(radius * 1.5)
	.innerRadius((d) => d.y0 * radius)
	.outerRadius((d) => Math.max(d.y0 * radius, d.y1 * radius - 1));

const path = g
	.append("g")
	.selectAll("path")
	.data(root.descendants().slice(1))
	.join("path")
	.attr("fill", (d) => {
		while (d.depth > 1) d = d.parent;
		return color(d.data.name);
	})
	.attr("fill-opacity", (d) =>
		arcVisible(d.current) ? (d.children ? 0.6 : 0.4) : 0
	)
	.attr("d", (d) => arc(d.current));

path
	.filter((d) => d.children)
	.style("cursor", "pointer")
	.on("click", clicked);

const format = d3.format(",d");

path.append("title").text(
	(d) =>
		`${d
			.ancestors()
			.map((d) => d.data.name)
			.reverse()
			.join("/")}\n${format(d.value)}`
);

const label = g
	.append("g")
	.attr("pointer-events", "none")
	.attr("text-anchor", "middle")
	.style("user-select", "none")
	.selectAll("text")
	.data(root.descendants().slice(1))
	.join("text")
	.attr("dy", "0.35em")
	.attr("fill-opacity", (d) => +labelVisible(d.current))
	.attr("transform", (d) => labelTransform(d.current))
	.text((d) => d.data.name);

const parent = g
	.append("circle")
	.datum(root)
	.attr("r", radius)
	.attr("fill", "none")
	.attr("pointer-events", "all")
	.on("click", clicked);

function clicked(event, p) {
	parent.datum(p.parent || root);

	root.each(
		(d) =>
			(d.target = {
				x0:
					Math.max(0, Math.min(1, (d.x0 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
				x1:
					Math.max(0, Math.min(1, (d.x1 - p.x0) / (p.x1 - p.x0))) * 2 * Math.PI,
				y0: Math.max(0, d.y0 - p.depth),
				y1: Math.max(0, d.y1 - p.depth),
			})
	);

	const t = g.transition().duration(750);

	// Transition the data on all arcs, even the ones that aren’t visible,
	// so that if this transition is interrupted, entering arcs will start
	// the next transition from the desired position.
	path
		.transition(t)
		.tween("data", (d) => {
			const i = d3.interpolate(d.current, d.target);
			return (t) => (d.current = i(t));
		})
		.filter(function (d) {
			return +this.getAttribute("fill-opacity") || arcVisible(d.target);
		})
		.attr("fill-opacity", (d) =>
			arcVisible(d.target) ? (d.children ? 0.6 : 0.4) : 0
		)
		.attrTween("d", (d) => () => arc(d.current));

	label
		.filter(function (d) {
			return +this.getAttribute("fill-opacity") || labelVisible(d.target);
		})
		.transition(t)
		.attr("fill-opacity", (d) => +labelVisible(d.target))
		.attrTween("transform", (d) => () => labelTransform(d.current));
}

function arcVisible(d) {
	return d.y1 <= 3 && d.y0 >= 1 && d.x1 > d.x0;
}

function labelVisible(d) {
	return d.y1 <= 3 && d.y0 >= 1 && (d.y1 - d.y0) * (d.x1 - d.x0) > 0.03;
}

function labelTransform(d) {
	const x = (((d.x0 + d.x1) / 2) * 180) / Math.PI;
	const y = ((d.y0 + d.y1) / 2) * radius;
	return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
}

document.getElementById("chart").appendChild(svg.node());
